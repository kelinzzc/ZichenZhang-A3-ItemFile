<div class="event-detail-page" ng-controller="EventDetailController as vm">
    <div class="container">
        <!-- 加载状态 -->
        <div ng-if="vm.isLoading" class="text-center">
            <div class="spinner"></div>
            <p>加载活动详情中...</p>
        </div>

        <!-- 活动详情 -->
        <div ng-if="!vm.isLoading && vm.event">
            <!-- 活动头部 -->
            <div class="event-header">
                <div class="breadcrumb">
                    <a href="/events">活动列表</a>
                    <i class="fas fa-chevron-right"></i>
                    <span>{{vm.event.title}}</span>
                </div>
                
                <h1 class="event-title">{{vm.event.title}}</h1>
                
                <div class="event-meta">
                    <div class="meta-badges">
                        <span class="badge category">{{vm.event.category_name}}</span>
                        <span class="badge organization">{{vm.event.organization_name}}</span>
                        <span class="badge status" ng-class="{'active': vm.event.is_active && !vm.event.is_suspended, 'inactive': !vm.event.is_active || vm.event.is_suspended}">
                            {{vm.event.is_active && !vm.event.is_suspended ? '进行中' : '已结束'}}
                        </span>
                    </div>
                    
                    <div class="meta-details">
                        <div class="detail-item">
                            <i class="fas fa-calendar"></i>
                            <strong>活动时间:</strong> {{$root.formatDate(vm.event.event_date)}}
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <strong>活动地点:</strong> {{vm.event.location}}
                        </div>
                        <div class="detail-item" ng-if="vm.event.venue_details">
                            <i class="fas fa-info-circle"></i>
                            <strong>场地详情:</strong> {{vm.event.venue_details}}
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- 主要内容 -->
                <div class="col-lg-8">
                    <!-- 标签页导航 -->
                    <div class="tabs">
                        <button class="tab-button" 
                                ng-class="{active: vm.activeTab === 'details'}"
                                ng-click="vm.setActiveTab('details')">
                            活动详情
                        </button>
                        <button class="tab-button" 
                                ng-class="{active: vm.activeTab === 'registrations'}"
                                ng-click="vm.setActiveTab('registrations')">
                            参与记录 ({{vm.registrations.length}})
                        </button>
                    </div>

                    <!-- 活动详情标签页 -->
                    <div class="tab-content" ng-show="vm.activeTab === 'details'">
                        <div class="card">
                            <div class="card-body">
                                <!-- 活动图片 -->
                                <div class="event-image-large">
                                    <img ng-src="{{vm.event.image_url || 'assets/images/event-default.jpg'}}" 
                                         alt="{{vm.event.title}}">
                                </div>

                                <!-- 活动描述 -->
                                <div class="event-description">
                                    <h3>活动介绍</h3>
                                    <p>{{vm.event.full_description || vm.event.description}}</p>
                                </div>

                                <!-- 天气信息 -->
                                <div class="weather-section" ng-if="vm.weather">
                                    <h3>活动当天天气预报</h3>
                                    <weather-widget weather="vm.weather"></weather-widget>
                                </div>

                                <!-- 筹款进度 -->
                                <div class="funding-progress">
                                    <h3>筹款进度</h3>
                                    <div class="progress-stats">
                                        <div class="progress-numbers">
                                            <span class="current">{{$root.formatCurrency(vm.event.current_amount)}}</span>
                                            <span class="goal">目标 {{$root.formatCurrency(vm.event.goal_amount)}}</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" 
                                                 ng-style="{width: $root.calculateProgress(vm.event.current_amount, vm.event.goal_amount) + '%'}"></div>
                                        </div>
                                        <div class="progress-percentage">
                                            {{$root.calculateProgress(vm.event.current_amount, vm.event.goal_amount)}}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 参与记录标签页 -->
                    <div class="tab-content" ng-show="vm.activeTab === 'registrations'">
                        <div class="card">
                            <div class="card-header">
                                <h3>活动参与记录</h3>
                                <p class="text-muted">按注册时间倒序排列</p>
                            </div>
                            <div class="card-body">
                                <registration-list registrations="vm.registrations"></registration-list>
                                
                                <div ng-if="vm.registrations.length === 0" class="text-center">
                                    <p>暂无参与记录</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 侧边栏 -->
                <div class="col-lg-4">
                    <div class="sidebar">
                        <!-- 注册卡片 -->
                        <div class="card registration-card" ng-if="vm.canRegister()">
                            <div class="card-header">
                                <h3>立即参与</h3>
                            </div>
                            <div class="card-body">
                                <div class="ticket-info">
                                    <div class="ticket-price">
                                        <span class="price" ng-if="vm.event.ticket_price > 0">
                                            {{$root.formatCurrency(vm.event.ticket_price)}}
                                        </span>
                                        <span class="price free" ng-if="vm.event.ticket_price === 0">
                                            免费参与
                                        </span>
                                        <span class="per-ticket" ng-if="vm.event.ticket_price > 0">/ 每人</span>
                                    </div>
                                    
                                    <div class="available-tickets">
                                        <i class="fas fa-ticket-alt"></i>
                                        剩余 {{vm.getAvailableTickets()}} 张票
                                    </div>
                                </div>
                                
                                <a ng-href="/register/{{vm.event.id}}" class="btn btn-primary btn-lg btn-block">
                                    <i class="fas fa-user-plus"></i>
                                    立即注册
                                </a>
                                
                                <div class="registration-stats">
                                    <div class="stat">
                                        <strong>{{vm.getRegistrationStats().totalRegistrations}}</strong>
                                        <span>已注册人数</span>
                                    </div>
                                    <div class="stat">
                                        <strong>{{vm.getRegistrationStats().totalTickets}}</strong>
                                        <span>总票数</span>
                                    </div>
                                    <div class="stat">
                                        <strong>{{vm.getRegistrationStats().averageTickets}}</strong>
                                        <span>平均票数/人</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 活动信息卡片 -->
                        <div class="card info-card">
                            <div class="card-header">
                                <h3>活动信息</h3>
                            </div>
                            <div class="card-body">
                                <div class="info-item">
                                    <i class="fas fa-users"></i>
                                    <div>
                                        <strong>参与人数</strong>
                                        <p>最多 {{vm.event.max_attendees}} 人</p>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <div>
                                        <strong>筹款目标</strong>
                                        <p>{{$root.formatCurrency(vm.event.goal_amount)}}</p>
                                    </div>
                                </div>
                                
                                <div class="info-item">
                                    <i class="fas fa-building"></i>
                                    <div>
                                        <strong>组织方</strong>
                                        <p>{{vm.event.organization_name}}</p>
                                    </div>
                                </div>
                                
                                <div class="info-item" ng-if="vm.event.contact_email">
                                    <i class="fas fa-envelope"></i>
                                    <div>
                                        <strong>联系方式</strong>
                                        <p>{{vm.event.contact_email}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 不可注册提示 -->
                        <div class="card alert-card" ng-if="!vm.canRegister()">
                            <div class="card-body text-center">
                                <i class="fas fa-info-circle"></i>
                                <p>该活动目前无法注册</p>
                                <p class="text-muted">可能的原因：活动已结束、暂停或票已售完</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 错误状态 -->
        <div ng-if="!vm.isLoading && !vm.event" class="text-center error-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h2>活动不存在</h2>
            <p>抱歉，找不到您要查看的活动。</p>
            <a href="/events" class="btn btn-primary">返回活动列表</a>
        </div>
    </div>
</div>